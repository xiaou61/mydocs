<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.53" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://mydocs.guoyaxue.top/codenotes/Java/jvm/10.html"><meta property="og:site_name" content="小uの学习笔记"><meta property="og:title" content="JVM系列-第10章-垃圾回收概述和相关算法"><meta property="og:description" content="JVM系列-第10章-垃圾回收概述和相关算法。"><meta property="og:type" content="article"><meta property="og:image" content="https://npm.elemecdn.com/lql_static@latest/logo/jvm.png"><meta property="og:updated_time" content="2023-08-02T10:33:49.000Z"><meta property="og:locale" content="zh-CN"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:image:alt" content="JVM系列-第10章-垃圾回收概述和相关算法"><meta property="article:tag" content="JVM"><meta property="article:tag" content="虚拟机"><meta property="article:modified_time" content="2023-08-02T10:33:49.000Z"><link rel="icon" href="/favicon.svg"><script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ef5d300e271d63833a52446f97a78f7d";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
     </script><title>JVM系列-第10章-垃圾回收概述和相关算法 | 小uの学习笔记</title><meta name="description" content="JVM系列-第10章-垃圾回收概述和相关算法。">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="preload" href="/assets/style.e2ddb5bf.css" as="style" /><link rel="stylesheet" href="/assets/style.e2ddb5bf.css" />
    <link rel="modulepreload" href="/assets/app.c5b3201b.js"><link rel="modulepreload" href="/assets/10.html.4cc6a34e.js"><link rel="modulepreload" href="/assets/_plugin-vue_export-helper.cdc0426e.js"><link rel="modulepreload" href="/assets/10.html.7fb4acf5.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">跳至主要內容</a><!--]--><div class="theme-container has-toc"><!--[--><!--[--><header class="navbar"><div class="navbar-left"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!--[--><!----><!--]--><a href="/" class="brand"><img class="logo" src="/site_logo.png" alt="小uの学习笔记"><!----><span class="site-name hide-in-pad">小uの学习笔记</span></a><!--[--><!----><!--]--></div><div class="navbar-center"><!--[--><!----><!--]--><nav class="nav-links"><div class="nav-item hide-in-mobile"><a href="/quicknav/" class="nav-link" aria-label="快速导航"><span class="icon iconfont icon-navigation"></span>快速导航<!----></a></div><div class="nav-item hide-in-mobile"><a href="/blog/" class="nav-link" aria-label="博客主页"><span class="icon iconfont icon-blog"></span>博客主页<!----></a></div><div class="nav-item hide-in-mobile"><a href="/codenotes/" class="nav-link active" aria-label="代码笔记"><span class="icon iconfont icon-code"></span>代码笔记<!----></a></div><div class="nav-item hide-in-mobile"><a href="/projects/" class="nav-link" aria-label="技术杂谈"><span class="icon iconfont icon-code"></span>技术杂谈<!----></a></div><div class="nav-item hide-in-mobile"><a href="/interview/" class="nav-link" aria-label="面试"><span class="icon iconfont icon-code"></span>面试<!----></a></div><div class="nav-item hide-in-mobile"><a href="/practice/" class="nav-link" aria-label="项目实战"><span class="icon iconfont icon-code"></span>项目实战<!----></a></div></nav><!--[--><!----><!--]--></div><div class="navbar-right"><!--[--><!----><!--]--><!----><div class="nav-item"><a class="repo-link" href="https://gitee.com/lizifan233/mydocs" target="_blank" rel="noopener noreferrer" aria-label="Gitee"><svg xmlns="http://www.w3.org/2000/svg" class="icon gitee-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="gitee icon" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M512 992C246.92 992 32 777.08 32 512S246.92 32 512 32s480 214.92 480 480-214.92 480-480 480zm242.97-533.34H482.39a23.7 23.7 0 0 0-23.7 23.7l-.03 59.28c0 13.08 10.59 23.7 23.7 23.7h165.96a23.7 23.7 0 0 1 23.7 23.7v11.85a71.1 71.1 0 0 1-71.1 71.1H375.71a23.7 23.7 0 0 1-23.7-23.7V423.11a71.1 71.1 0 0 1 71.1-71.1h331.8a23.7 23.7 0 0 0 23.7-23.7l.06-59.25a23.73 23.73 0 0 0-23.7-23.73H423.11a177.78 177.78 0 0 0-177.78 177.75v331.83c0 13.08 10.62 23.7 23.7 23.7h349.62a159.99 159.99 0 0 0 159.99-159.99V482.33a23.7 23.7 0 0 0-23.7-23.7z"></path></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="搜索本站" autocomplete="off" spellcheck="false" value><!----></form><!--[--><!----><!--]--><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-java"></span><span class="title">Java</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-write"></span><span class="title">JavaSE精修</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-write"></span><span class="title">重学Java(千锋教育2023)</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable active"><span class="icon iconfont icon-write"></span><span class="title">JVM(尚硅谷)</span><span class="arrow down"></span></button><ul class="sidebar-links"><li><!--[--><a href="/codenotes/Java/jvm/1.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第1章-JVM与Java体系结构"><!---->JVM系列-第1章-JVM与Java体系结构<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/2.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第2章-类加载子系统"><!---->JVM系列-第2章-类加载子系统<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/3.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第3章-运行时数据区"><!---->JVM系列-第3章-运行时数据区<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/4.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第4章-虚拟机栈"><!---->JVM系列-第4章-虚拟机栈<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/5.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第5章-堆"><!---->JVM系列-第5章-堆<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/6.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第6章-方法区"><!---->JVM系列-第6章-方法区<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/7.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第7章-对象的实例化内存布局与访问定位"><!---->JVM系列-第7章-对象的实例化内存布局与访问定位<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/8.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第8章-执行引擎"><!---->JVM系列-第8章-执行引擎<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/9.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第9章-StringTable(字符串常量池)"><!---->JVM系列-第9章-StringTable(字符串常量池)<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a aria-current="page" href="/codenotes/Java/jvm/10.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" aria-label="JVM系列-第10章-垃圾回收概述和相关算法"><!---->JVM系列-第10章-垃圾回收概述和相关算法<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#大厂面试题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="大厂面试题"><!---->大厂面试题<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#蚂蚁金服" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="蚂蚁金服"><!---->蚂蚁金服<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#百度" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="百度"><!---->百度<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#天猫" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="天猫"><!---->天猫<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#滴滴" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="滴滴"><!---->滴滴<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#京东" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="京东"><!---->京东<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#阿里" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="阿里"><!---->阿里<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#字节跳动" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="字节跳动"><!---->字节跳动<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#什么是垃圾" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="什么是垃圾？"><!---->什么是垃圾？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#为什么需要gc" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="为什么需要GC？"><!---->为什么需要GC？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#早期垃圾回收" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="早期垃圾回收"><!---->早期垃圾回收<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#java-垃圾回收机制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="Java 垃圾回收机制"><!---->Java 垃圾回收机制<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#自动内存管理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="自动内存管理"><!---->自动内存管理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#应该关心哪些区域的回收" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="应该关心哪些区域的回收？"><!---->应该关心哪些区域的回收？<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#标记阶段-引用计数算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="标记阶段：引用计数算法"><!---->标记阶段：引用计数算法<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#标记阶段的目的" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="标记阶段的目的"><!---->标记阶段的目的<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#引用计数算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="引用计数算法"><!---->引用计数算法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#循环引用" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="循环引用"><!---->循环引用<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#证明-java使用的不是引用计数算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="证明：java使用的不是引用计数算法"><!---->证明：java使用的不是引用计数算法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#小结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="小结"><!---->小结<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#标记阶段-可达性分析算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="标记阶段：可达性分析算法"><!---->标记阶段：可达性分析算法<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#可达性分析实现思路" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="可达性分析实现思路"><!---->可达性分析实现思路<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#gc-roots可以是哪些元素" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="GC Roots可以是哪些元素？"><!---->GC Roots可以是哪些元素？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#注意" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="注意"><!---->注意<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#对象的-finalization-机制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="对象的 finalization 机制"><!---->对象的 finalization 机制<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#finalize-方法机制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="finalize() 方法机制"><!---->finalize() 方法机制<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#生存还是死亡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="生存还是死亡？"><!---->生存还是死亡？<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#具体过程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="具体过程"><!---->具体过程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#代码演示-finalize-方法可复活对象" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="代码演示 finalize() 方法可复活对象"><!---->代码演示 finalize() 方法可复活对象<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#mat与jprofiler的gc-roots溯源" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="MAT与JProfiler的GC Roots溯源"><!---->MAT与JProfiler的GC Roots溯源<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#mat-介绍" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="MAT 介绍"><!---->MAT 介绍<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#获取-dump-文件方式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="获取 dump 文件方式"><!---->获取 dump 文件方式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#捕捉-dump-示例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="捕捉 dump 示例"><!---->捕捉 dump 示例<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#jprofiler-gc-roots-溯源" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="JProfiler GC Roots 溯源"><!---->JProfiler GC Roots 溯源<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#jprofiler-分析-oom" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="JProfiler 分析 OOM"><!---->JProfiler 分析 OOM<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#清除阶段-标记-清除算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="清除阶段：标记-清除算法"><!---->清除阶段：标记-清除算法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#清除阶段-复制算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="清除阶段：复制算法"><!---->清除阶段：复制算法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#清除阶段-标记-压缩算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="清除阶段：标记-压缩算法"><!---->清除阶段：标记-压缩算法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#垃圾回收算法小结" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="垃圾回收算法小结"><!---->垃圾回收算法小结<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#分代收集算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="分代收集算法"><!---->分代收集算法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#增量收集算法和分区算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="增量收集算法和分区算法"><!---->增量收集算法和分区算法<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#增量收集算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="增量收集算法"><!---->增量收集算法<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#分区算法" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="分区算法"><!---->分区算法<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/codenotes/Java/jvm/10.html#写在最后" class="router-link-active router-link-exact-active nav-link sidebar-link heading" aria-label="写在最后"><!---->写在最后<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/11.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第11章-垃圾回收相关概念"><!---->JVM系列-第11章-垃圾回收相关概念<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><a href="/codenotes/Java/jvm/12.html" class="nav-link sidebar-link sidebar-page" aria-label="JVM系列-第12章-垃圾回收器"><!---->JVM系列-第12章-垃圾回收器<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-write"></span><span class="title">JVM(doocs)</span><span class="arrow right"></span></button><!----></section></li><li><!--[--><a href="/codenotes/Java/spring6.html" class="nav-link sidebar-link sidebar-page" aria-label="spring6"><span class="icon iconfont icon-write"></span>spring6<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-write"></span><span class="title">coder1v5笔记</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-write"></span><span class="title">设计模式(黑马)</span><span class="arrow right"></span></button><!----></section></li></ul></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-html"></span><span class="title">前端</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-ability"></span><span class="title">算法</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-python"></span><span class="title">python</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-workingDirectory"></span><span class="title">其他技术</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-linter"></span><span class="title">逆向</span><span class="arrow right"></span></button><!----></section></li><li><section class="sidebar-group"><button class="sidebar-heading clickable"><span class="icon iconfont icon-linter"></span><span class="title">推荐书籍</span><span class="arrow right"></span></button><!----></section></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!--[--><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->JVM系列-第10章-垃圾回收概述和相关算法</h1><div class="page-info"><!----><!----><span class="reading-time-info" aria-label="阅读时间⌛" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>大约 34 分钟</span><meta property="timeRequired" content="PT34M"></span><span class="date-info" aria-label="写作日期📅" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2023-08-02T10:33:49.000Z"></span><span class="words-info" aria-label="字数🔠" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon word-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="word icon"><path d="M518.217 432.64V73.143A73.143 73.143 0 01603.43 1.097a512 512 0 01419.474 419.474 73.143 73.143 0 01-72.046 85.212H591.36a73.143 73.143 0 01-73.143-73.143z"></path><path d="M493.714 566.857h340.297a73.143 73.143 0 0173.143 85.577A457.143 457.143 0 11371.566 117.76a73.143 73.143 0 0185.577 73.143v339.383a36.571 36.571 0 0036.571 36.571z"></path></svg><span>约 10341 字</span><meta property="wordCount" content="10341"></span><span class="author-info" aria-label="作者🖊" data-balloon-pos="down"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><a class="author-item" href="https://gitee.com/lizifan233/mydocs" target="_blank" rel="noopener noreferrer">Xiaou</a></span><span property="author" content="Xiaou"></span></span><!----></div><hr></div><div class="toc-place-holder"><aside id="toc"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#大厂面试题" class="router-link-active router-link-exact-active toc-link level2">大厂面试题</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#蚂蚁金服" class="router-link-active router-link-exact-active toc-link level3">蚂蚁金服</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#百度" class="router-link-active router-link-exact-active toc-link level3">百度</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#天猫" class="router-link-active router-link-exact-active toc-link level3">天猫</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#滴滴" class="router-link-active router-link-exact-active toc-link level3">滴滴</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#京东" class="router-link-active router-link-exact-active toc-link level3">京东</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#阿里" class="router-link-active router-link-exact-active toc-link level3">阿里</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#字节跳动" class="router-link-active router-link-exact-active toc-link level3">字节跳动</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#什么是垃圾" class="router-link-active router-link-exact-active toc-link level2">什么是垃圾？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#为什么需要gc" class="router-link-active router-link-exact-active toc-link level2">为什么需要GC？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#早期垃圾回收" class="router-link-active router-link-exact-active toc-link level2">早期垃圾回收</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#java-垃圾回收机制" class="router-link-active router-link-exact-active toc-link level2">Java 垃圾回收机制</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#自动内存管理" class="router-link-active router-link-exact-active toc-link level3">自动内存管理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#应该关心哪些区域的回收" class="router-link-active router-link-exact-active toc-link level3">应该关心哪些区域的回收？</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#标记阶段-引用计数算法" class="router-link-active router-link-exact-active toc-link level2">标记阶段：引用计数算法</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#标记阶段的目的" class="router-link-active router-link-exact-active toc-link level3">标记阶段的目的</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#引用计数算法" class="router-link-active router-link-exact-active toc-link level3">引用计数算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#循环引用" class="router-link-active router-link-exact-active toc-link level3">循环引用</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#证明-java使用的不是引用计数算法" class="router-link-active router-link-exact-active toc-link level3">证明：java使用的不是引用计数算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#小结" class="router-link-active router-link-exact-active toc-link level3">小结</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#标记阶段-可达性分析算法" class="router-link-active router-link-exact-active toc-link level2">标记阶段：可达性分析算法</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#可达性分析实现思路" class="router-link-active router-link-exact-active toc-link level3">可达性分析实现思路</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#gc-roots可以是哪些元素" class="router-link-active router-link-exact-active toc-link level3">GC Roots可以是哪些元素？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#注意" class="router-link-active router-link-exact-active toc-link level3">注意</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#对象的-finalization-机制" class="router-link-active router-link-exact-active toc-link level2">对象的 finalization 机制</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#finalize-方法机制" class="router-link-active router-link-exact-active toc-link level3">finalize() 方法机制</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#生存还是死亡" class="router-link-active router-link-exact-active toc-link level3">生存还是死亡？</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#具体过程" class="router-link-active router-link-exact-active toc-link level3">具体过程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#代码演示-finalize-方法可复活对象" class="router-link-active router-link-exact-active toc-link level3">代码演示 finalize() 方法可复活对象</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#mat与jprofiler的gc-roots溯源" class="router-link-active router-link-exact-active toc-link level2">MAT与JProfiler的GC Roots溯源</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#mat-介绍" class="router-link-active router-link-exact-active toc-link level3">MAT 介绍</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#获取-dump-文件方式" class="router-link-active router-link-exact-active toc-link level3">获取 dump 文件方式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#捕捉-dump-示例" class="router-link-active router-link-exact-active toc-link level3">捕捉 dump 示例</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#jprofiler-gc-roots-溯源" class="router-link-active router-link-exact-active toc-link level3">JProfiler GC Roots 溯源</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#jprofiler-分析-oom" class="router-link-active router-link-exact-active toc-link level3">JProfiler 分析 OOM</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#清除阶段-标记-清除算法" class="router-link-active router-link-exact-active toc-link level2">清除阶段：标记-清除算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#清除阶段-复制算法" class="router-link-active router-link-exact-active toc-link level2">清除阶段：复制算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#清除阶段-标记-压缩算法" class="router-link-active router-link-exact-active toc-link level2">清除阶段：标记-压缩算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#垃圾回收算法小结" class="router-link-active router-link-exact-active toc-link level2">垃圾回收算法小结</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#分代收集算法" class="router-link-active router-link-exact-active toc-link level2">分代收集算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#增量收集算法和分区算法" class="router-link-active router-link-exact-active toc-link level2">增量收集算法和分区算法</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#增量收集算法" class="router-link-active router-link-exact-active toc-link level3">增量收集算法</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#分区算法" class="router-link-active router-link-exact-active toc-link level3">分区算法</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/codenotes/Java/jvm/10.html#写在最后" class="router-link-active router-link-exact-active toc-link level2">写在最后</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><h1 id="垃圾回收概述" tabindex="-1"><a class="header-anchor" href="#垃圾回收概述" aria-hidden="true">#</a> 垃圾回收概述</h1><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0001.png"><ol><li><p>Java 和 C++语言的区别，就在于垃圾收集技术和内存动态分配上，C++语言没有垃圾收集技术，需要程序员手动的收集。</p></li><li><p>垃圾收集，不是Java语言的伴生产物。早在1960年，第一门开始使用内存动态分配和垃圾收集技术的Lisp语言诞生。</p></li><li><p>关于垃圾收集有三个经典问题：</p><ul><li>哪些内存需要回收？</li><li>什么时候回收？</li><li>如何回收？</li></ul></li><li><p>垃圾收集机制是Java的招牌能力，极大地提高了开发效率。如今，垃圾收集几乎成为现代语言的标配，即使经过如此长时间的发展，Java的垃圾收集机制仍然在不断的演进中，不同大小的设备、不同特征的应用场景，对垃圾收集提出了新的挑战，这当然也是面试的热点。</p></li></ol><h2 id="大厂面试题" tabindex="-1"><a class="header-anchor" href="#大厂面试题" aria-hidden="true">#</a> 大厂面试题</h2><h3 id="蚂蚁金服" tabindex="-1"><a class="header-anchor" href="#蚂蚁金服" aria-hidden="true">#</a> 蚂蚁金服</h3><ol><li>你知道哪几种垃圾回收器，各自的优缺点，重点讲一下CMS和G1？</li><li>JVM GC算法有哪些，目前的JDK版本采用什么回收算法？</li><li>G1回收器讲下回收过程GC是什么？为什么要有GC？</li><li>GC的两种判定方法？CMS收集器与G1收集器的特点</li></ol><h3 id="百度" tabindex="-1"><a class="header-anchor" href="#百度" aria-hidden="true">#</a> 百度</h3><ol><li>说一下GC算法，分代回收说下</li><li>垃圾收集策略和算法</li></ol><h3 id="天猫" tabindex="-1"><a class="header-anchor" href="#天猫" aria-hidden="true">#</a> 天猫</h3><ol><li>JVM GC原理，JVM怎么回收内存</li><li>CMS特点，垃圾回收算法有哪些？各自的优缺点，他们共同的缺点是什么？</li></ol><h3 id="滴滴" tabindex="-1"><a class="header-anchor" href="#滴滴" aria-hidden="true">#</a> 滴滴</h3><ol><li>Java的垃圾回收器都有哪些，说下G1的应用场景，平时你是如何搭配使用垃圾回收器的</li></ol><h3 id="京东" tabindex="-1"><a class="header-anchor" href="#京东" aria-hidden="true">#</a> 京东</h3><ol><li>你知道哪几种垃圾收集器，各自的优缺点，重点讲下CMS和G1，</li><li>包括原理，流程，优缺点。垃圾回收算法的实现原理</li></ol><h3 id="阿里" tabindex="-1"><a class="header-anchor" href="#阿里" aria-hidden="true">#</a> 阿里</h3><ol><li>讲一讲垃圾回收算法。</li><li>什么情况下触发垃圾回收？</li><li>如何选择合适的垃圾收集算法？</li><li>JVM有哪三种垃圾回收器？</li></ol><h3 id="字节跳动" tabindex="-1"><a class="header-anchor" href="#字节跳动" aria-hidden="true">#</a> 字节跳动</h3><ol><li>常见的垃圾回收器算法有哪些，各有什么优劣？</li><li>System.gc()和Runtime.gc()会做什么事情？</li><li>Java GC机制？GC Roots有哪些？</li><li>Java对象的回收方式，回收算法。</li><li>CMS和G1了解么，CMS解决什么问题，说一下回收的过程。</li><li>CMS回收停顿了几次，为什么要停顿两次?</li></ol><h2 id="什么是垃圾" tabindex="-1"><a class="header-anchor" href="#什么是垃圾" aria-hidden="true">#</a> 什么是垃圾？</h2><ol><li>垃圾是指<strong>在运行程序中没有任何指针指向的对象</strong>，这个对象就是需要被回收的垃圾。</li><li>外文：An object is considered garbage when it can no longer be reached from any pointer in the running program.</li><li>如果不及时对内存中的垃圾进行清理，那么，这些垃圾对象所占的内存空间会一直保留到应用程序结束，被保留的空间无法被其他对象使用。甚至可能导致内存溢出。</li></ol><p><strong>十几年前磁盘碎片整理的日子</strong></p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0002.jpg"><h2 id="为什么需要gc" tabindex="-1"><a class="header-anchor" href="#为什么需要gc" aria-hidden="true">#</a> 为什么需要GC？</h2><p><strong>想要学习GC，首先需要理解为什么需要GC？</strong></p><ol><li><p>对于高级语言来说，一个基本认知是如果不进行垃圾回收，<strong>内存迟早都会被消耗完</strong>，因为不断地分配内存空间而不进行回收，就好像不停地生产生活垃圾而从来不打扫一样。</p></li><li><p>除了释放没用的对象，垃圾回收也可以清除内存里的记录碎片。碎片整理将所占用的堆内存移到堆的一端，<strong>以便JVM将整理出的内存分配给新的对象</strong>。</p></li><li><p>随着应用程序所应付的业务越来越庞大、复杂，用户越来越多，<strong>没有GC就不能保证应用程序的正常进行</strong>。而经常造成STW的GC又跟不上实际的需求，所以才会不断地尝试对GC进行优化。</p></li></ol><h2 id="早期垃圾回收" tabindex="-1"><a class="header-anchor" href="#早期垃圾回收" aria-hidden="true">#</a> 早期垃圾回收</h2><ol><li>在早期的C/C++时代，垃圾回收基本上是手工进行的。开发人员可以使用new关键字进行内存申请，并使用delete关键字进行内存释放。比如以下代码：</li></ol><div class="language-c++ line-numbers-mode" data-ext="c++"><pre class="language-c++"><code>  MibBridge *pBridge= new cmBaseGroupBridge（）；
  //如果注册失败，使用Delete释放该对象所占内存区域
  if（pBridge-&gt;Register（kDestroy）！=NO ERROR）
  	delete pBridge；
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ol start="2"><li><p>这种方式可以灵活控制内存释放的时间，但是会给开发人员带来<strong>频繁申请和释放内存的管理负担</strong>。倘若有一处内存区间由于程序员编码的问题忘记被回收，那么就会产生<strong>内存泄漏</strong>，垃圾对象永远无法被清除，随着系统运行时间的不断增长，垃圾对象所耗内存可能持续上升，直到出现内存溢出并造成<strong>应用程序崩溃</strong>。</p></li><li><p>有了垃圾回收机制后，上述代码极有可能变成这样</p></li></ol><div class="language-c++ line-numbers-mode" data-ext="c++"><pre class="language-c++"><code>  MibBridge *pBridge=new cmBaseGroupBridge(); 
  pBridge-&gt;Register(kDestroy);
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><ol start="4"><li>现在，除了Java以外，C#、Python、Ruby等语言都使用了自动垃圾回收的思想，也是未来发展趋势，可以说这种自动化的内存分配和来及回收方式已经成为了现代开发语言必备的标准。</li></ol><h2 id="java-垃圾回收机制" tabindex="-1"><a class="header-anchor" href="#java-垃圾回收机制" aria-hidden="true">#</a> Java 垃圾回收机制</h2><h3 id="自动内存管理" tabindex="-1"><a class="header-anchor" href="#自动内存管理" aria-hidden="true">#</a> 自动内存管理</h3><blockquote><p><strong>官网介绍</strong>：<a href="https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/8/docs/technotes/guides/vm/gctuning/toc.html<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></blockquote><p><strong>自动内存管理的优点</strong></p><ol><li><p>自动内存管理，无需开发人员手动参与内存的分配与回收，这样降低内存泄漏和内存溢出的风险</p></li><li><p>没有垃圾回收器，java也会和cpp一样，各种悬垂指针，野指针，泄露问题让你头疼不已。</p></li><li><p>自动内存管理机制，将程序员从繁重的内存管理中释放出来，可以更专心地专注于业务开发</p></li></ol><p><strong>关于自动内存管理的担忧</strong></p><ol><li>对于Java开发人员而言，自动内存管理就像是一个黑匣子，如果过度依赖于“自动”，那么这将会是一场灾难，最严重的就会<strong>弱化Java开发人员在程序出现内存溢出时定位问题和解决问题的能力</strong>。</li><li>此时，了解JVM的自动内存分配和内存回收原理就显得非常重要，只有在真正了解JVM是如何管理内存后，我们才能够在遇见OutofMemoryError时，快速地根据错误异常日志定位问题和解决问题。</li><li>当需要排查各种内存溢出、内存泄漏问题时，当垃圾收集成为系统达到更高并发量的瓶颈时，我们就必须对这些“自动化”的技术<strong>实施必要的监控和调节</strong>。</li></ol><h3 id="应该关心哪些区域的回收" tabindex="-1"><a class="header-anchor" href="#应该关心哪些区域的回收" aria-hidden="true">#</a> 应该关心哪些区域的回收？</h3><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0003.png"><ol><li><p>垃圾收集器可以对年轻代回收，也可以对老年代回收，甚至是全栈和方法区的回收，</p></li><li><p>其中，<strong>Java堆是垃圾收集器的工作重点</strong></p></li><li><p>从次数上讲：</p><ol><li>频繁收集Young区</li><li>较少收集Old区</li><li>基本不收集Perm区（元空间）</li></ol></li></ol><h1 id="垃圾回收相关算法" tabindex="-1"><a class="header-anchor" href="#垃圾回收相关算法" aria-hidden="true">#</a> 垃圾回收相关算法</h1><h2 id="标记阶段-引用计数算法" tabindex="-1"><a class="header-anchor" href="#标记阶段-引用计数算法" aria-hidden="true">#</a> 标记阶段：引用计数算法</h2><h3 id="标记阶段的目的" tabindex="-1"><a class="header-anchor" href="#标记阶段的目的" aria-hidden="true">#</a> 标记阶段的目的</h3><p><strong>垃圾标记阶段：主要是为了判断对象是否存活</strong></p><ol><li>在堆里存放着几乎所有的Java对象实例，在GC执行垃圾回收之前，首先<strong>需要区分出内存中哪些是存活对象，哪些是已经死亡的对象。<strong>只有被标记为己经死亡的对象，GC才会在执行垃圾回收时，释放掉其所占用的内存空间，因此这个过程我们可以称为</strong>垃圾标记阶段</strong>。</li><li>那么在JVM中究竟是如何标记一个死亡对象呢？简单来说，当一个对象已经不再被任何的存活对象继续引用时，就可以宣判为已经死亡。</li><li>判断对象存活一般有两种方式：<strong>引用计数算法</strong>和<strong>可达性分析算法</strong>。</li></ol><h3 id="引用计数算法" tabindex="-1"><a class="header-anchor" href="#引用计数算法" aria-hidden="true">#</a> 引用计数算法</h3><ol><li>引用计数算法（Reference Counting）比较简单，对每个对象保存一个整型的引用计数器属性。用于记录对象被引用的情况。</li><li>对于一个对象A，只要有任何一个对象引用了A，则A的引用计数器就加1；当引用失效时，引用计数器就减1。只要对象A的引用计数器的值为0，即表示对象A不可能再被使用，可进行回收。</li><li>优点：实现简单，垃圾对象便于辨识；判定效率高，回收没有延迟性。</li><li>缺点： <ol><li>它需要单独的字段存储计数器，这样的做法增加了<strong>存储空间的开销</strong>。</li><li>每次赋值都需要更新计数器，伴随着加法和减法操作，这增加了<strong>时间开销</strong>。</li><li>引用计数器有一个严重的问题，即<strong>无法处理循环引用</strong>的情况。这是一条致命缺陷，导致在Java的垃圾回收器中没有使用这类算法。</li></ol></li></ol><h3 id="循环引用" tabindex="-1"><a class="header-anchor" href="#循环引用" aria-hidden="true">#</a> 循环引用</h3><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0004.png"><p>当p的指针断开的时候，内部的引用形成一个循环，计数器都还算1，无法被回收，这就是循环引用，从而造成内存泄漏</p><h3 id="证明-java使用的不是引用计数算法" tabindex="-1"><a class="header-anchor" href="#证明-java使用的不是引用计数算法" aria-hidden="true">#</a> 证明：java使用的不是引用计数算法</h3><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * -XX:+PrintGCDetails
 * 证明：java使用的不是引用计数算法
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefCountGC</span> <span class="token punctuation">{</span>
    <span class="token comment">//这个成员属性唯一的作用就是占用一点内存</span>
    <span class="token keyword">private</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bigSize <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">5</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//5MB</span>

    <span class="token class-name">Object</span> reference <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">RefCountGC</span> obj1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefCountGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">RefCountGC</span> obj2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefCountGC</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        obj1<span class="token punctuation">.</span>reference <span class="token operator">=</span> obj2<span class="token punctuation">;</span>
        obj2<span class="token punctuation">.</span>reference <span class="token operator">=</span> obj1<span class="token punctuation">;</span>

        obj1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        obj2 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//显式的执行垃圾回收行为</span>
        <span class="token comment">//这里发生GC，obj1和obj2能否被回收？</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0005.png"><ul><li>如果不小心直接把<code>obj1.reference</code>和<code>obj2.reference</code>置为null。则在Java堆中的两块内存依然保持着互相引用，无法被回收</li></ul><p><strong>没有进行GC时</strong></p><p>把下面的几行代码注释掉，让它来不及</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>        <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//把这行代码注释掉</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-text line-numbers-mode" data-ext="text"><pre class="language-text"><code>Heap
 PSYoungGen      total 38400K, used 14234K [0x00000000d5f80000, 0x00000000d8a00000, 0x0000000100000000)
  eden space 33280K, 42% used [0x00000000d5f80000,0x00000000d6d66be8,0x00000000d8000000)
  from space 5120K, 0% used [0x00000000d8500000,0x00000000d8500000,0x00000000d8a00000)
  to   space 5120K, 0% used [0x00000000d8000000,0x00000000d8000000,0x00000000d8500000)
 ParOldGen       total 87552K, used 0K [0x0000000081e00000, 0x0000000087380000, 0x00000000d5f80000)
  object space 87552K, 0% used [0x0000000081e00000,0x0000000081e00000,0x0000000087380000)
 Metaspace       used 3496K, capacity 4498K, committed 4864K, reserved 1056768K
  class space    used 387K, capacity 390K, committed 512K, reserved 1048576K

Process finished with exit code 0
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>进行GC</strong></p><p>打开那行代码的注释</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token punctuation">[</span><span class="token constant">GC</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">PSYoungGen</span><span class="token operator">:</span> <span class="token number">13569</span>K<span class="token operator">-&gt;</span><span class="token function">808K</span><span class="token punctuation">(</span><span class="token number">38400</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token number">13569</span>K<span class="token operator">-&gt;</span><span class="token function">816K</span><span class="token punctuation">(</span><span class="token number">125952</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0.0012717</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.00</span> secs<span class="token punctuation">]</span> 
<span class="token punctuation">[</span><span class="token class-name">Full</span> <span class="token constant">GC</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">[</span><span class="token class-name">PSYoungGen</span><span class="token operator">:</span> <span class="token number">808</span>K<span class="token operator">-&gt;</span><span class="token function">0K</span><span class="token punctuation">(</span><span class="token number">38400</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">ParOldGen</span><span class="token operator">:</span> <span class="token number">8</span>K<span class="token operator">-&gt;</span><span class="token function">670K</span><span class="token punctuation">(</span><span class="token number">87552</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span> <span class="token number">816</span>K<span class="token operator">-&gt;</span><span class="token function">670K</span><span class="token punctuation">(</span><span class="token number">125952</span>K<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token class-name">Metaspace</span><span class="token operator">:</span> <span class="token number">3491</span>K<span class="token operator">-&gt;</span><span class="token function">3491K</span><span class="token punctuation">(</span><span class="token number">1056768</span>K<span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token number">0.0051769</span> secs<span class="token punctuation">]</span> <span class="token punctuation">[</span><span class="token class-name">Times</span><span class="token operator">:</span> user<span class="token operator">=</span><span class="token number">0.00</span> sys<span class="token operator">=</span><span class="token number">0.00</span><span class="token punctuation">,</span> real<span class="token operator">=</span><span class="token number">0.00</span> secs<span class="token punctuation">]</span> 
<span class="token class-name">Heap</span>
 <span class="token class-name">PSYoungGen</span>      total <span class="token number">38400</span>K<span class="token punctuation">,</span> used <span class="token number">333</span>K <span class="token punctuation">[</span><span class="token number">0x00000000d5f80000</span><span class="token punctuation">,</span> <span class="token number">0x00000000d8a00000</span><span class="token punctuation">,</span> <span class="token number">0x0000000100000000</span><span class="token punctuation">)</span>
  eden space <span class="token number">33280</span>K<span class="token punctuation">,</span> <span class="token number">1</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000d5f80000</span><span class="token punctuation">,</span><span class="token number">0x00000000d5fd34a8</span><span class="token punctuation">,</span><span class="token number">0x00000000d8000000</span><span class="token punctuation">)</span>
  from space <span class="token number">5120</span>K<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000d8000000</span><span class="token punctuation">,</span><span class="token number">0x00000000d8000000</span><span class="token punctuation">,</span><span class="token number">0x00000000d8500000</span><span class="token punctuation">)</span>
  <span class="token keyword">to</span>   <span class="token namespace">space</span> <span class="token number">5120</span>K<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x00000000d8500000</span><span class="token punctuation">,</span><span class="token number">0x00000000d8500000</span><span class="token punctuation">,</span><span class="token number">0x00000000d8a00000</span><span class="token punctuation">)</span>
 <span class="token class-name">ParOldGen</span>       total <span class="token number">87552</span>K<span class="token punctuation">,</span> used <span class="token number">670</span>K <span class="token punctuation">[</span><span class="token number">0x0000000081e00000</span><span class="token punctuation">,</span> <span class="token number">0x0000000087380000</span><span class="token punctuation">,</span> <span class="token number">0x00000000d5f80000</span><span class="token punctuation">)</span>
  object space <span class="token number">87552</span>K<span class="token punctuation">,</span> <span class="token number">0</span><span class="token operator">%</span> used <span class="token punctuation">[</span><span class="token number">0x0000000081e00000</span><span class="token punctuation">,</span><span class="token number">0x0000000081ea7990</span><span class="token punctuation">,</span><span class="token number">0x0000000087380000</span><span class="token punctuation">)</span>
 <span class="token class-name">Metaspace</span>       used <span class="token number">3498</span>K<span class="token punctuation">,</span> capacity <span class="token number">4498</span>K<span class="token punctuation">,</span> committed <span class="token number">4864</span>K<span class="token punctuation">,</span> reserved <span class="token number">1056768</span>K
  <span class="token keyword">class</span> space    used <span class="token number">387</span>K<span class="token punctuation">,</span> capacity <span class="token number">390</span>K<span class="token punctuation">,</span> committed <span class="token number">512</span>K<span class="token punctuation">,</span> reserved <span class="token number">1048576</span>K

<span class="token class-name">Process</span> finished <span class="token keyword">with</span> <span class="token namespace">exit</span> code <span class="token number">0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、从打印日志就可以明显看出来，已经进行了GC</p><p>2、如果使用引用计数算法，那么这两个对象将会无法回收。而现在两个对象被回收了，说明Java使用的不是引用计数算法来进行标记的。</p><h3 id="小结" tabindex="-1"><a class="header-anchor" href="#小结" aria-hidden="true">#</a> 小结</h3><ol><li>引用计数算法，是很多语言的资源回收选择，例如因人工智能而更加火热的Python，它更是同时支持引用计数和垃圾收集机制。</li><li>具体哪种最优是要看场景的，业界有大规模实践中仅保留引用计数机制，以提高吞吐量的尝试。</li><li>Java并没有选择引用计数，是因为其存在一个基本的难题，也就是很难处理循环引用关系。</li><li>Python如何解决循环引用？ <ul><li>手动解除：很好理解，就是在合适的时机，解除引用关系。</li><li>使用弱引用weakref，weakref是Python提供的标准库，旨在解决循环引用。</li></ul></li></ol><h2 id="标记阶段-可达性分析算法" tabindex="-1"><a class="header-anchor" href="#标记阶段-可达性分析算法" aria-hidden="true">#</a> 标记阶段：可达性分析算法</h2><p><strong>可达性分析算法：也可以称为根搜索算法、追踪性垃圾收集</strong></p><ol><li>相对于引用计数算法而言，可达性分析算法不仅同样具备实现简单和执行高效等特点，更重要的是该算法可以有效地<strong>解决在引用计数算法中循环引用的问题，防止内存泄漏的发生</strong>。</li><li>相较于引用计数算法，这里的可达性分析就是Java、C#选择的。这种类型的垃圾收集通常也叫作<strong>追踪性垃圾收集</strong>（Tracing Garbage Collection）</li></ol><h3 id="可达性分析实现思路" tabindex="-1"><a class="header-anchor" href="#可达性分析实现思路" aria-hidden="true">#</a> 可达性分析实现思路</h3><ul><li><p>所谓&quot;GCRoots”根集合就是一组必须活跃的引用</p></li><li><p>其基本思路如下：</p></li></ul><ol><li>可达性分析算法是以根对象集合（GCRoots）为起始点，按照从上至下的方式<strong>搜索被根对象集合所连接的目标对象是否可达。</strong></li><li>使用可达性分析算法后，内存中的存活对象都会被根对象集合直接或间接连接着，搜索所走过的路径称为<strong>引用链</strong>（Reference Chain）</li><li>如果目标对象没有任何引用链相连，则是不可达的，就意味着该对象己经死亡，可以标记为垃圾对象。</li><li>在可达性分析算法中，只有能够被根对象集合直接或者间接连接的对象才是存活对象。</li></ol><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0006.png"><h3 id="gc-roots可以是哪些元素" tabindex="-1"><a class="header-anchor" href="#gc-roots可以是哪些元素" aria-hidden="true">#</a> GC Roots可以是哪些元素？</h3><ol><li>虚拟机栈中引用的对象 <ul><li>比如：各个线程被调用的方法中使用到的参数、局部变量等。</li></ul></li><li>本地方法栈内JNI（通常说的本地方法）引用的对象</li><li>方法区中类静态属性引用的对象 <ul><li>比如：Java类的引用类型静态变量</li></ul></li><li>方法区中常量引用的对象 <ul><li>比如：字符串常量池（StringTable）里的引用</li></ul></li><li>所有被同步锁synchronized持有的对象</li><li>Java虚拟机内部的引用。 <ul><li>基本数据类型对应的Class对象，一些常驻的异常对象（如：NullPointerException、OutofMemoryError），系统类加载器。</li></ul></li><li>反映java虚拟机内部情况的JMXBean、JVMTI中注册的回调、本地代码缓存等。</li></ol><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0007.png"><ol><li>总结一句话就是，除了堆空间的周边，比如：虚拟机栈、本地方法栈、方法区、字符串常量池等地方对堆空间进行引用的，都可以作为GC Roots进行可达性分析</li><li>除了这些固定的GC Roots集合以外，根据用户所选用的垃圾收集器以及当前回收的内存区域不同，还可以有其他对象“临时性”地加入，共同构成完整GC Roots集合。比如：<strong>分代收集</strong>和局部回收（PartialGC）。 <ul><li>如果只针对Java堆中的某一块区域进行垃圾回收（比如：典型的只针对新生代），必须考虑到内存区域是虚拟机自己的实现细节，更不是孤立封闭的，这个区域的对象完全有可能被其他区域的对象所引用，这时候就需要一并将关联的区域对象也加入GC Roots集合中去考虑，才能保证可达性分析的准确性。</li></ul></li></ol><p><strong>小技巧</strong></p><p>由于Root采用栈方式存放变量和指针，所以如果一个指针，它保存了堆内存里面的对象，但是自己又不存放在堆内存里面，那它就是一个Root。</p><h3 id="注意" tabindex="-1"><a class="header-anchor" href="#注意" aria-hidden="true">#</a> 注意</h3><ol><li>如果要使用可达性分析算法来判断内存是否可回收，那么分析工作必须在一个能保障一致性的快照中进行。这点不满足的话分析结果的准确性就无法保证。</li><li>这点也是导致GC进行时必须“Stop The World”的一个重要原因。即使是号称（几乎）不会发生停顿的CMS收集器中，<strong>枚举根节点时也是必须要停顿的</strong>。</li></ol><h2 id="对象的-finalization-机制" tabindex="-1"><a class="header-anchor" href="#对象的-finalization-机制" aria-hidden="true">#</a> 对象的 finalization 机制</h2><h3 id="finalize-方法机制" tabindex="-1"><a class="header-anchor" href="#finalize-方法机制" aria-hidden="true">#</a> finalize() 方法机制</h3><p><strong>对象销毁前的回调函数：finalize()</strong></p><ol><li><p>Java语言提供了对象终止（finalization）机制来允许开发人员提供<strong>对象被销毁之前的自定义处理逻辑</strong>。</p></li><li><p>当垃圾回收器发现没有引用指向一个对象，即：垃圾回收此对象之前，总会先调用这个对象的finalize()方法。</p></li><li><p>finalize() 方法允许在子类中被重写，<strong>用于在对象被回收时进行资源释放</strong>。通常在这个方法中进行一些资源释放和清理的工作，比如关闭文件、套接字和数据库连接等。</p></li></ol><p>Object 类中 finalize() 源码</p><pre><code>// 等待被重写
protected void finalize() throws Throwable { }
</code></pre><ol><li>永远不要主动调用某个对象的finalize()方法，应该交给垃圾回收机制调用。理由包括下面三点： <ol><li>在finalize()时可能会导致对象复活。</li><li>finalize()方法的执行时间是没有保障的，它完全由GC线程决定，极端情况下，若不发生GC，则finalize()方法将没有执行机会。</li><li>一个糟糕的finalize()会严重影响GC的性能。比如finalize是个死循环</li></ol></li><li>从功能上来说，finalize()方法与C++中的析构函数比较相似，但是Java采用的是基于垃圾回收器的自动内存管理机制，所以finalize()方法在<strong>本质上不同于C++中的析构函数</strong>。</li><li>finalize()方法对应了一个finalize线程，因为优先级比较低，即使主动调用该方法，也不会因此就直接进行回收</li></ol><h3 id="生存还是死亡" tabindex="-1"><a class="header-anchor" href="#生存还是死亡" aria-hidden="true">#</a> 生存还是死亡？</h3><p>由于finalize()方法的存在，<strong>虚拟机中的对象一般处于三种可能的状态。</strong></p><ol><li>如果从所有的根节点都无法访问到某个对象，说明对象己经不再使用了。一般来说，此对象需要被回收。但事实上，也并非是“非死不可”的，这时候它们暂时处于“缓刑”阶段。<strong>一个无法触及的对象有可能在某一个条件下“复活”自己</strong>，如果这样，那么对它立即进行回收就是不合理的。为此，定义虚拟机中的对象可能的三种状态。如下： <ol><li>可触及的：从根节点开始，可以到达这个对象。</li><li>可复活的：对象的所有引用都被释放，但是对象有可能在finalize()中复活。</li><li>不可触及的：对象的finalize()被调用，并且没有复活，那么就会进入不可触及状态。不可触及的对象不可能被复活，<strong>因为finalize()只会被调用一次</strong>。</li></ol></li><li>以上3种状态中，是由于finalize()方法的存在，进行的区分。只有在对象不可触及时才可以被回收。</li></ol><h3 id="具体过程" tabindex="-1"><a class="header-anchor" href="#具体过程" aria-hidden="true">#</a> 具体过程</h3><p>判定一个对象objA是否可回收，至少要经历两次标记过程：</p><ol><li>如果对象objA到GC Roots没有引用链，则进行第一次标记。</li><li>进行筛选，判断此对象是否有必要执行finalize()方法 <ol><li>如果对象objA没有重写finalize()方法，或者finalize()方法已经被虚拟机调用过，则虚拟机视为“没有必要执行”，objA被判定为不可触及的。</li><li>如果对象objA重写了finalize()方法，且还未执行过，那么objA会被插入到F-Queue队列中，由一个虚拟机自动创建的、低优先级的Finalizer线程触发其finalize()方法执行。</li><li>finalize()方法是对象逃脱死亡的最后机会，稍后GC会对F-Queue队列中的对象进行第二次标记。如果objA在finalize()方法中与引用链上的任何一个对象建立了联系，那么在第二次标记时，objA会被移出“即将回收”集合。之后，对象会再次出现没有引用存在的情况。在这个情况下，finalize()方法不会被再次调用，对象会直接变成不可触及的状态，也就是说，一个对象的finalize()方法只会被调用一次。</li></ol></li></ol><p><strong>通过 JVisual VM 查看 Finalizer 线程</strong></p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0008.png"><h3 id="代码演示-finalize-方法可复活对象" tabindex="-1"><a class="header-anchor" href="#代码演示-finalize-方法可复活对象" aria-hidden="true">#</a> 代码演示 finalize() 方法可复活对象</h3><p>我们重写 CanReliveObj 类的 finalize()方法，在调用其 finalize()方法时，将 obj 指向当前类对象 this</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * 测试Object类中finalize()方法，即对象的finalization机制。
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CanReliveObj</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">CanReliveObj</span> obj<span class="token punctuation">;</span><span class="token comment">//类变量，属于 GC Root</span>


    <span class="token comment">//此方法只能被调用一次</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用当前类重写的finalize()方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//当前待回收的对象在finalize()方法中与引用链上的一个对象obj建立了联系</span>
    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            obj <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CanReliveObj</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 对象第一次成功拯救自己</span>
            obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//调用垃圾回收器</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;第1次 gc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 因为Finalizer线程优先级很低，暂停2秒，以等待它</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;obj is dead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;obj is still alive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;第2次 gc&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 下面这段代码与上面的完全相同，但是这次自救却失败了</span>
            obj <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">gc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 因为Finalizer线程优先级很低，暂停2秒，以等待它</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>obj <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;obj is dead&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;obj is still alive&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>如果注释掉finalize()方法</strong></p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code> <span class="token comment">//此方法只能被调用一次</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;调用当前类重写的finalize()方法&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span><span class="token comment">//当前待回收的对象在finalize()方法中与引用链上的一个对象obj建立了联系</span>
    <span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出结果：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>第<span class="token number">1</span>次 gc
obj is dead
第<span class="token number">2</span>次 gc
obj is dead
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>放开finalize()方法</strong></p><p>输出结果：</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code>第<span class="token number">1</span>次 gc
调用当前类重写的<span class="token function">finalize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>方法
obj is still alive
第<span class="token number">2</span>次 gc
obj is dead

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>第一次自救成功，但由于 finalize() 方法只会执行一次，所以第二次自救失败</p><h2 id="mat与jprofiler的gc-roots溯源" tabindex="-1"><a class="header-anchor" href="#mat与jprofiler的gc-roots溯源" aria-hidden="true">#</a> MAT与JProfiler的GC Roots溯源</h2><h3 id="mat-介绍" tabindex="-1"><a class="header-anchor" href="#mat-介绍" aria-hidden="true">#</a> MAT 介绍</h3><ol><li>MAT是Memory Analyzer的简称，它是一款功能强大的Java堆内存分析器。用于查找内存泄漏以及查看内存消耗情况。</li><li>MAT是基于Eclipse开发的，是一款免费的性能分析工具。</li><li>大家可以在<a href="http://www.eclipse.org/mat/%E4%B8%8B%E8%BD%BD%E5%B9%B6%E4%BD%BF%E7%94%A8MAT" target="_blank" rel="noopener noreferrer">http://www.eclipse.org/mat/下载并使用MAT<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ol><blockquote><p>1、虽然Jvisualvm很强大，但是在内存分析方面，还是MAT更好用一些</p><p>2、此小节主要是为了实时分析GC Roots是哪些东西，中间需要用到一个dump的文件</p></blockquote><h3 id="获取-dump-文件方式" tabindex="-1"><a class="header-anchor" href="#获取-dump-文件方式" aria-hidden="true">#</a> 获取 dump 文件方式</h3><p><strong>方式一：命令行使用 jmap</strong></p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0009.png"><p><strong>方式二：使用JVisualVM</strong></p><ol><li>捕获的heap dump文件是一个临时文件，关闭JVisualVM后自动删除，若要保留，需要将其另存为文件。可通过以下方法捕获heap dump：</li><li>操作步骤下面演示</li></ol><h3 id="捕捉-dump-示例" tabindex="-1"><a class="header-anchor" href="#捕捉-dump-示例" aria-hidden="true">#</a> 捕捉 dump 示例</h3><h4 id="使用jvisualvm捕捉-heap-dump" tabindex="-1"><a class="header-anchor" href="#使用jvisualvm捕捉-heap-dump" aria-hidden="true">#</a> 使用JVisualVM捕捉 heap dump</h4><p>代码：</p><ul><li>numList 和 birth 在第一次捕捉内存快照的时候，为 GC Roots</li><li>之后 numList 和 birth 置为 null ，对应的引用对象被回收，在第二次捕捉内存快照的时候，就不再是 GC Roots</li></ul><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GCRootsTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> numList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> birth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;数据添加完毕，请操作：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        birth <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;numList、birth已置空，请操作：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>如何捕捉堆内存快照</strong></p><p>1、先执行第一步，然后停下来，去生成此步骤dump文件</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0010.png"><p>2、 点击【堆 Dump】</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0011.png"><p>3、右键 --&gt; 另存为即可</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0012.jpg"><p>4、输入命令，继续执行程序</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0013.png"><p>5、我们接着捕获第二张堆内存快照</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0014.jpg"><h4 id="使用-mat-查看堆内存快照" tabindex="-1"><a class="header-anchor" href="#使用-mat-查看堆内存快照" aria-hidden="true">#</a> 使用 MAT 查看堆内存快照</h4><p>1、打开 MAT ，选择File --&gt; Open File，打开刚刚的两个dump文件，<strong>我们先打开第一个dump文件</strong></p><blockquote><p>点击Open Heap Dump也行</p></blockquote><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0015.png"><p>2、选择Java Basics --&gt; GC Roots</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0016.png"><p>3、第一次捕捉堆内存快照时，GC Roots 中包含我们定义的两个局部变量，类型分别为 ArrayList 和 Date，Total:21</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0017.jpg"><p>4、打开第二个dump文件，第二次捕获内存快照时，由于两个局部变量引用的对象被释放，所以这两个局部变量不再作为 GC Roots ，从 Total Entries = 19 也可以看出（少了两个 GC Roots）</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0018.jpg"><h3 id="jprofiler-gc-roots-溯源" tabindex="-1"><a class="header-anchor" href="#jprofiler-gc-roots-溯源" aria-hidden="true">#</a> JProfiler GC Roots 溯源</h3><p>1、在实际开发中，我们很少会查看所有的GC Roots。一般都是查看某一个或几个对象的GC Root是哪个，这个过程叫<strong>GC Roots 溯源</strong></p><p>2、下面我们使用使用 JProfiler 进行 GC Roots 溯源演示</p><p>依然用下面这个代码</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GCRootsTest</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> numList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Date</span> birth <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">100</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            numList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InterruptedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;数据添加完毕，请操作：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        numList <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        birth <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;numList、birth已置空，请操作：&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;结束&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>1、</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0019.jpg"><p>2、</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0020.png"><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0021.jpg"><p>可以发现颜色变绿了，可以动态的看变化</p><p>3、右击对象，选择 Show Selection In Heap Walker，单独的查看某个对象</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0022.png"><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0023.png"><p>4、选择Incoming References，表示追寻 GC Roots 的源头</p><p>点击Show Paths To GC Roots，在弹出界面中选择默认设置即可</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0024.jpg"><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0025.png"><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0026.png"><h3 id="jprofiler-分析-oom" tabindex="-1"><a class="header-anchor" href="#jprofiler-分析-oom" aria-hidden="true">#</a> JProfiler 分析 OOM</h3><blockquote><p>这里是简单的讲一下，后面篇章会详解</p></blockquote><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token doc-comment comment">/**
 * -Xms8m -Xmx8m 
 * -XX:+HeapDumpOnOutOfMemoryError  这个参数的意思是当程序出现OOM的时候就会在当前工程目录生成一个dump文件
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HeapOOM</span> <span class="token punctuation">{</span>
    <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//1MB</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HeapOOM</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span><span class="token punctuation">{</span>
            <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HeapOOM</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                count<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;count = &quot;</span> <span class="token operator">+</span> count<span class="token punctuation">)</span><span class="token punctuation">;</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>程序输出日志</p><div class="language-java line-numbers-mode" data-ext="java"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span>HeapOOM</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
<span class="token class-name">Dumping</span> heap <span class="token keyword">to</span> <span class="token namespace">java_pid14608<span class="token punctuation">.</span>hprof</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>OutOfMemoryError</span><span class="token operator">:</span> <span class="token class-name">Java</span> heap space
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span>HeapOOM</span><span class="token punctuation">.</span><span class="token generics"><span class="token punctuation">&lt;</span>init<span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">HeapOOM</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">12</span><span class="token punctuation">)</span>
	at <span class="token class-name"><span class="token namespace">com<span class="token punctuation">.</span>atguigu<span class="token punctuation">.</span>java<span class="token punctuation">.</span></span>HeapOOM</span><span class="token punctuation">.</span><span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">HeapOOM</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token class-name">Heap</span> dump file created <span class="token punctuation">[</span><span class="token number">7797849</span> bytes in <span class="token number">0.010</span> secs<span class="token punctuation">]</span>
count <span class="token operator">=</span> <span class="token number">6</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打开这个dump文件</p><p>1、看这个超大对象</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0027.png"><p>2、揪出 main() 线程中出问题的代码</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0028.png"><h2 id="清除阶段-标记-清除算法" tabindex="-1"><a class="header-anchor" href="#清除阶段-标记-清除算法" aria-hidden="true">#</a> 清除阶段：标记-清除算法</h2><p><strong>垃圾清除阶段</strong></p><ul><li>当成功区分出内存中存活对象和死亡对象后，GC接下来的任务就是执行垃圾回收，释放掉无用对象所占用的内存空间，以便有足够的可用内存空间为新对象分配内存。目前在JVM中比较常见的三种垃圾收集算法是</li></ul><ol><li>标记-清除算法（Mark-Sweep）</li><li>复制算法（Copying）</li><li>标记-压缩算法（Mark-Compact）</li></ol><p><strong>背景</strong></p><p>标记-清除算法（Mark-Sweep）是一种非常基础和常见的垃圾收集算法，该算法被J.McCarthy等人在1960年提出并并应用于Lisp语言。</p><p><strong>执行过程</strong></p><p>当堆中的有效内存空间（available memory）被耗尽的时候，就会停止整个程序（也被称为stop the world），然后进行两项工作，第一项则是标记，第二项则是清除</p><ol><li>标记：Collector从引用根节点开始遍历，标记所有被引用的对象。一般是在对象的Header中记录为可达对象。 <ul><li>注意：标记的是被引用的对象，也就是可达对象，并非标记的是即将被清除的垃圾对象</li></ul></li><li>清除：Collector对堆内存从头到尾进行线性的遍历，如果发现某个对象在其Header中没有标记为可达对象，则将其回收</li></ol><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0029.png"><p><strong>标记-清除算法的缺点</strong></p><ol><li>标记清除算法的效率不算高</li><li>在进行GC的时候，需要停止整个应用程序，用户体验较差</li><li>这种方式清理出来的空闲内存是不连续的，产生内碎片，需要维护一个空闲列表</li></ol><p><strong>注意：何为清除？</strong></p><p>这里所谓的清除并不是真的置空，而是把需要清除的对象地址保存在空闲的地址列表里。下次有新对象需要加载时，判断垃圾的位置空间是否够，如果够，就存放（也就是覆盖原有的地址）。</p><p>关于空闲列表是在为对象分配内存的时候提过：</p><ol><li>如果内存规整 <ul><li>采用指针碰撞的方式进行内存分配</li></ul></li><li>如果内存不规整 <ul><li>虚拟机需要维护一个空闲列表</li><li>采用空闲列表分配内存</li></ul></li></ol><h2 id="清除阶段-复制算法" tabindex="-1"><a class="header-anchor" href="#清除阶段-复制算法" aria-hidden="true">#</a> 清除阶段：复制算法</h2><p><strong>背景</strong></p><ol><li>为了解决标记-清除算法在垃圾收集效率方面的缺陷，M.L.Minsky于1963年发表了著名的论文，“使用双存储区的Lisp语言垃圾收集器CA LISP Garbage Collector Algorithm Using Serial Secondary Storage）”。M.L.Minsky在该论文中描述的算法被人们称为复制（Copying）算法，它也被M.L.Minsky本人成功地引入到了Lisp语言的一个实现版本中。</li></ol><p><strong>核心思想</strong></p><p>将活着的内存空间分为两块，每次只使用其中一块，在垃圾回收时将正在使用的内存中的存活对象复制到未被使用的内存块中，之后清除正在使用的内存块中的所有对象，交换两个内存的角色，最后完成垃圾回收</p><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0030.png"><p>新生代里面就用到了复制算法，Eden区和S0区存活对象整体复制到S1区</p><p><strong>复制算法的优缺点</strong></p><p><strong>优点</strong></p><ol><li>没有标记和清除过程，实现简单，运行高效</li><li>复制过去以后保证空间的连续性，不会出现“碎片”问题。</li></ol><p><strong>缺点</strong></p><ol><li>此算法的缺点也是很明显的，就是需要两倍的内存空间。</li><li>对于G1这种分拆成为大量region的GC，复制而不是移动，意味着GC需要维护region之间对象引用关系，不管是内存占用或者时间开销也不小</li></ol><p><strong>复制算法的应用场景</strong></p><ol><li>如果系统中的垃圾对象很多，复制算法需要复制的存活对象数量并不会太大，效率较高</li><li>老年代大量的对象存活，那么复制的对象将会有很多，效率会很低</li><li>在新生代，对常规应用的垃圾回收，一次通常可以回收70% - 99% 的内存空间。回收性价比很高。所以现在的商业虚拟机都是用这种收集算法回收新生代。</li></ol><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0031.png"><h2 id="清除阶段-标记-压缩算法" tabindex="-1"><a class="header-anchor" href="#清除阶段-标记-压缩算法" aria-hidden="true">#</a> 清除阶段：标记-压缩算法</h2><p><strong>标记-压缩（或标记-整理、Mark - Compact）算法</strong></p><p><strong>背景</strong></p><ol><li><p>复制算法的高效性是建立在存活对象少、垃圾对象多的前提下的。这种情况在新生代经常发生，但是在老年代，更常见的情况是大部分对象都是存活对象。如果依然使用复制算法，由于存活对象较多，复制的成本也将很高。因此，<strong>基于老年代垃圾回收的特性，需要使用其他的算法。</strong></p></li><li><p>标记-清除算法的确可以应用在老年代中，但是该算法不仅执行效率低下，而且在执行完内存回收后还会产生内存碎片，所以JVM的设计者需要在此基础之上进行改进。标记-压缩（Mark-Compact）算法由此诞生。</p></li><li><p>1970年前后，G.L.Steele、C.J.Chene和D.s.Wise等研究者发布标记-压缩算法。在许多现代的垃圾收集器中，人们都使用了标记-压缩算法或其改进版本。</p></li></ol><p><strong>执行过程</strong></p><ol><li><p>第一阶段和标记清除算法一样，从根节点开始标记所有被引用对象</p></li><li><p>第二阶段将所有的存活对象压缩到内存的一端，按顺序排放。之后，清理边界外所有的空间。</p></li></ol><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0032.png"><p><strong>标记-压缩算法与标记-清除算法的比较</strong></p><ol><li><p>标记-压缩算法的最终效果等同于标记-清除算法执行完成后，再进行一次内存碎片整理，因此，也可以把它称为标记-清除-压缩（Mark-Sweep-Compact）算法。</p></li><li><p>二者的本质差异在于标记-清除算法是一种<strong>非移动式的回收算法</strong>，标记-压缩是<strong>移动式的</strong>。是否移动回收后的存活对象是一项优缺点并存的风险决策。</p></li><li><p>可以看到，标记的存活对象将会被整理，按照内存地址依次排列，而未被标记的内存会被清理掉。如此一来，当我们需要给新对象分配内存时，JVM只需要持有一个内存的起始地址即可，这比维护一个空闲列表显然少了许多开销。</p></li></ol><p><strong>标记-压缩算法的优缺点</strong></p><p><strong>优点</strong></p><ol><li>消除了标记-清除算法当中，内存区域分散的缺点，我们需要给新对象分配内存时，JVM只需要持有一个内存的起始地址即可。</li><li>消除了复制算法当中，内存减半的高额代价。</li></ol><p><strong>缺点</strong></p><ol><li>从效率上来说，标记-整理算法要低于复制算法。</li><li>移动对象的同时，如果对象被其他对象引用，则还需要调整引用的地址（因为HotSpot虚拟机采用的不是句柄池的方式，而是直接指针）</li><li>移动过程中，需要全程暂停用户应用程序。即：STW</li></ol><h2 id="垃圾回收算法小结" tabindex="-1"><a class="header-anchor" href="#垃圾回收算法小结" aria-hidden="true">#</a> 垃圾回收算法小结</h2><blockquote><p><strong>对比三种清除阶段的算法</strong></p></blockquote><ol><li><p>效率上来说，复制算法是当之无愧的老大，但是却浪费了太多内存。</p></li><li><p>而为了尽量兼顾上面提到的三个指标，标记-整理算法相对来说更平滑一些，但是效率上不尽如人意，它比复制算法多了一个标记的阶段，比标记-清除多了一个整理内存的阶段。</p></li></ol><table><thead><tr><th></th><th>标记清除</th><th>标记整理</th><th>复制</th></tr></thead><tbody><tr><td><strong>速率</strong></td><td>中等</td><td>最慢</td><td>最快</td></tr><tr><td><strong>空间开销</strong></td><td>少（但会堆积碎片）</td><td>少（不堆积碎片）</td><td>通常需要活对象的2倍空间（不堆积碎片）</td></tr><tr><td><strong>移动对象</strong></td><td>否</td><td>是</td><td>是</td></tr></tbody></table><h2 id="分代收集算法" tabindex="-1"><a class="header-anchor" href="#分代收集算法" aria-hidden="true">#</a> 分代收集算法</h2><p>Q：难道就没有一种最优的算法吗？</p><p>A：无，没有最好的算法，只有最合适的算法</p><p><strong>为什么要使用分代收集算法</strong></p><ol><li><p>前面所有这些算法中，并没有一种算法可以完全替代其他算法，它们都具有自己独特的优势和特点。分代收集算法应运而生。</p></li><li><p>分代收集算法，是基于这样一个事实：**不同的对象的生命周期是不一样的。因此，不同生命周期的对象可以采取不同的收集方式，以便提高回收效率。**一般是把Java堆分为新生代和老年代，这样就可以根据各个年代的特点使用不同的回收算法，以提高垃圾回收的效率。</p></li><li><p>在Java程序运行的过程中，会产生大量的对象，其中有些对象是与业务信息相关:</p><ul><li>比如Http请求中的Session对象、线程、Socket连接，这类对象跟业务直接挂钩，因此生命周期比较长。</li><li>但是还有一些对象，主要是程序运行过程中生成的临时变量，这些对象生命周期会比较短，比如：String对象，由于其不变类的特性，系统会产生大量的这些对象，有些对象甚至只用一次即可回收。</li></ul></li></ol><p><strong>目前几乎所有的GC都采用分代手机算法执行垃圾回收的</strong></p><p>在HotSpot中，基于分代的概念，GC所使用的内存回收算法必须结合年轻代和老年代各自的特点。</p><ol><li><p>年轻代（Young Gen）</p><ul><li>年轻代特点：区域相对老年代较小，对象生命周期短、存活率低，回收频繁。</li><li>这种情况复制算法的回收整理，速度是最快的。复制算法的效率只和当前存活对象大小有关，因此很适用于年轻代的回收。而复制算法内存利用率不高的问题，通过hotspot中的两个survivor的设计得到缓解。</li></ul></li><li><p>老年代（Tenured Gen）</p><ul><li>老年代特点：区域较大，对象生命周期长、存活率高，回收不及年轻代频繁。</li><li>这种情况存在大量存活率高的对象，复制算法明显变得不合适。一般是由标记-清除或者是标记-清除与标记-整理的混合实现。 <ul><li><p>Mark阶段的开销与存活对象的数量成正比。</p></li><li><p>Sweep阶段的开销与所管理区域的大小成正相关。</p></li><li><p>Compact阶段的开销与存活对象的数据成正比。</p></li></ul></li></ul></li><li><p>以HotSpot中的CMS回收器为例，CMS是基于Mark-Sweep实现的，对于对象的回收效率很高。对于碎片问题，CMS采用基于Mark-Compact算法的Serial Old回收器作为补偿措施：当内存回收不佳（碎片导致的Concurrent Mode Failure时），将采用Serial Old执行Full GC以达到对老年代内存的整理。</p></li><li><p>分代的思想被现有的虚拟机广泛使用。几乎所有的垃圾回收器都区分新生代和老年代</p></li></ol><h2 id="增量收集算法和分区算法" tabindex="-1"><a class="header-anchor" href="#增量收集算法和分区算法" aria-hidden="true">#</a> 增量收集算法和分区算法</h2><h3 id="增量收集算法" tabindex="-1"><a class="header-anchor" href="#增量收集算法" aria-hidden="true">#</a> 增量收集算法</h3><p>上述现有的算法，在垃圾回收过程中，应用软件将处于一种Stop the World的状态。在<strong>Stop the World</strong>状态下，应用程序所有的线程都会挂起，暂停一切正常的工作，等待垃圾回收的完成。如果垃圾回收时间过长，应用程序会被挂起很久，将严重影响用户体验或者系统的稳定性。为了解决这个问题，即对实时垃圾收集算法的研究直接导致了增量收集（Incremental Collecting）算法的诞生。</p><p><strong>增量收集算法基本思想</strong></p><ol><li>如果一次性将所有的垃圾进行处理，需要造成系统长时间的停顿，那么就可以让垃圾收集线程和应用程序线程交替执行。<strong>每次，垃圾收集线程只收集一小片区域的内存空间，接着切换到应用程序线程。依次反复，直到垃圾收集完成。</strong></li><li>总的来说，增量收集算法的基础仍是传统的标记-清除和复制算法。增量收集算法通过<strong>对线程间冲突的妥善处理，允许垃圾收集线程以分阶段的方式完成标记、清理或复制工作</strong></li></ol><p><strong>增量收集算法的缺点</strong></p><p>使用这种方式，由于在垃圾回收过程中，间断性地还执行了应用程序代码，所以能减少系统的停顿时间。但是，因为线程切换和上下文转换的消耗，会使得垃圾回收的总体成本上升，<strong>造成系统吞吐量的下降</strong>。</p><h3 id="分区算法" tabindex="-1"><a class="header-anchor" href="#分区算法" aria-hidden="true">#</a> 分区算法</h3><blockquote><p>主要针对G1收集器来说的</p></blockquote><ol><li>一般来说，在相同条件下，堆空间越大，一次GC时所需要的时间就越长，有关GC产生的停顿也越长。为了更好地控制GC产生的停顿时间，将一块大的内存区域分割成多个小块，根据目标的停顿时间，每次合理地回收若干个小区间，而不是整个堆空间，从而减少一次GC所产生的停顿。</li><li>分代算法将按照对象的生命周期长短划分成两个部分，分区算法将整个堆空间划分成连续的不同小区间。每一个小区间都独立使用，独立回收。这种算法的好处是可以控制一次回收多少个小区间。</li></ol><img src="https://npm.elemecdn.com/youthlql@1.0.8/JVM/chapter_010/0033.png"><h2 id="写在最后" tabindex="-1"><a class="header-anchor" href="#写在最后" aria-hidden="true">#</a> 写在最后</h2><p>注意，这些只是基本的算法思路，实际GC实现过程要复杂的多，目前还在发展中的前沿GC都是复合算法，并且并行和并发兼备。</p></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://gitee.com/lizifan233/mydocs/edit/master/src/codenotes/Java/jvm/10.md" rel="noopener noreferrer" target="_blank" aria-label="在【Gitee】上编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="edit icon"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></svg><!--]-->在【Gitee】上编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><!----></div><!----></footer><nav class="page-nav"><a href="/codenotes/Java/jvm/9.html" class="nav-link prev" aria-label="JVM系列-第9章-StringTable(字符串常量池)"><div class="hint"><span class="arrow left"></span>上一页</div><div class="link"><!---->JVM系列-第9章-StringTable(字符串常量池)</div></a><a href="/codenotes/Java/jvm/11.html" class="nav-link next" aria-label="JVM系列-第11章-垃圾回收相关概念"><div class="hint">下一页<span class="arrow right"></span></div><div class="link">JVM系列-第11章-垃圾回收相关概念<!----></div></a></nav><div class="waline-wrapper" darkmode="false" style="display:block;"><div data-waline provider="Waline"><!--v-if--><div class="wl-comment"><!--v-if--><div class="wl-panel"><div class="wl-header item3"><!--[--><div class="wl-header-item"><label for="wl-nick">昵称</label><input id="wl-nick" class="wl-input wl-nick" name="nick" type="text" value></div><div class="wl-header-item"><label for="wl-mail">邮箱</label><input id="wl-mail" class="wl-input wl-mail" name="mail" type="email" value></div><div class="wl-header-item"><label for="wl-link">网址</label><input id="wl-link" class="wl-input wl-link" name="link" type="text" value></div><!--]--></div><textarea id="wl-edit" class="wl-editor" placeholder="请留言。(填写邮箱可在被回复时收到邮件提醒)"></textarea><div class="wl-preview" style="display:none;"><hr><h4>预览:</h4><!-- eslint-disable-next-line vue/no-v-html --><div class="wl-content"></div></div><div class="wl-footer"><div class="wl-actions"><a href="https://guides.github.com/features/mastering-markdown/" title="Markdown Guide" aria-label="Markdown is supported" class="wl-action" target="_blank" rel="noreferrer"><svg width="16" height="16" ariaHidden="true"><path d="M14.85 3H1.15C.52 3 0 3.52 0 4.15v7.69C0 12.48.52 13 1.15 13h13.69c.64 0 1.15-.52 1.15-1.15v-7.7C16 3.52 15.48 3 14.85 3zM9 11H7V8L5.5 9.92 4 8v3H2V5h2l1.5 2L7 5h2v6zm2.99.5L9.5 8H11V5h2v3h1.5l-2.51 3.5z" fill="currentColor"></path></svg></a><button class="wl-action" title="表情" style="display:none;"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M563.2 463.3 677 540c1.7 1.2 3.7 1.8 5.8 1.8.7 0 1.4-.1 2-.2 2.7-.5 5.1-2.1 6.6-4.4l25.3-37.8c1.5-2.3 2.1-5.1 1.6-7.8s-2.1-5.1-4.4-6.6l-73.6-49.1 73.6-49.1c2.3-1.5 3.9-3.9 4.4-6.6.5-2.7 0-5.5-1.6-7.8l-25.3-37.8a10.1 10.1 0 0 0-6.6-4.4c-.7-.1-1.3-.2-2-.2-2.1 0-4.1.6-5.8 1.8l-113.8 76.6c-9.2 6.2-14.7 16.4-14.7 27.5.1 11 5.5 21.3 14.7 27.4zM387 348.8h-45.5c-5.7 0-10.4 4.7-10.4 10.4v153.3c0 5.7 4.7 10.4 10.4 10.4H387c5.7 0 10.4-4.7 10.4-10.4V359.2c0-5.7-4.7-10.4-10.4-10.4zm333.8 241.3-41-20a10.3 10.3 0 0 0-8.1-.5c-2.6.9-4.8 2.9-5.9 5.4-30.1 64.9-93.1 109.1-164.4 115.2-5.7.5-9.9 5.5-9.5 11.2l3.9 45.5c.5 5.3 5 9.5 10.3 9.5h.9c94.8-8 178.5-66.5 218.6-152.7 2.4-5 .3-11.2-4.8-13.6zm186-186.1c-11.9-42-30.5-81.4-55.2-117.1-24.1-34.9-53.5-65.6-87.5-91.2-33.9-25.6-71.5-45.5-111.6-59.2-41.2-14-84.1-21.1-127.8-21.1h-1.2c-75.4 0-148.8 21.4-212.5 61.7-63.7 40.3-114.3 97.6-146.5 165.8-32.2 68.1-44.3 143.6-35.1 218.4 9.3 74.8 39.4 145 87.3 203.3.1.2.3.3.4.5l36.2 38.4c1.1 1.2 2.5 2.1 3.9 2.6 73.3 66.7 168.2 103.5 267.5 103.5 73.3 0 145.2-20.3 207.7-58.7 37.3-22.9 70.3-51.5 98.1-85 27.1-32.7 48.7-69.5 64.2-109.1 15.5-39.7 24.4-81.3 26.6-123.8 2.4-43.6-2.5-87-14.5-129zm-60.5 181.1c-8.3 37-22.8 72-43 104-19.7 31.1-44.3 58.6-73.1 81.7-28.8 23.1-61 41-95.7 53.4-35.6 12.7-72.9 19.1-110.9 19.1-82.6 0-161.7-30.6-222.8-86.2l-34.1-35.8c-23.9-29.3-42.4-62.2-55.1-97.7-12.4-34.7-18.8-71-19.2-107.9-.4-36.9 5.4-73.3 17.1-108.2 12-35.8 30-69.2 53.4-99.1 31.7-40.4 71.1-72 117.2-94.1 44.5-21.3 94-32.6 143.4-32.6 49.3 0 97 10.8 141.8 32 34.3 16.3 65.3 38.1 92 64.8 26.1 26 47.5 56 63.6 89.2 16.2 33.2 26.6 68.5 31 105.1 4.6 37.5 2.7 75.3-5.6 112.3z" fill="currentColor"></path></svg></button><button class="wl-action" title="表情包"><svg width="24" height="24" fill="currentcolor" viewBox="0 0 24 24"><path style="transform: translateY(0.5px)" d="M18.968 10.5H15.968V11.484H17.984V12.984H15.968V15H14.468V9H18.968V10.5V10.5ZM8.984 9C9.26533 9 9.49967 9.09367 9.687 9.281C9.87433 9.46833 9.968 9.70267 9.968 9.984V10.5H6.499V13.5H8.468V12H9.968V14.016C9.968 14.2973 9.87433 14.5317 9.687 14.719C9.49967 14.9063 9.26533 15 8.984 15H5.984C5.70267 15 5.46833 14.9063 5.281 14.719C5.09367 14.5317 5 14.2973 5 14.016V9.985C5 9.70367 5.09367 9.46933 5.281 9.282C5.46833 9.09467 5.70267 9.001 5.984 9.001H8.984V9ZM11.468 9H12.968V15H11.468V9V9Z"></path><path d="M18.5 3H5.75C3.6875 3 2 4.6875 2 6.75V18C2 20.0625 3.6875 21.75 5.75 21.75H18.5C20.5625 21.75 22.25 20.0625 22.25 18V6.75C22.25 4.6875 20.5625 3 18.5 3ZM20.75 18C20.75 19.2375 19.7375 20.25 18.5 20.25H5.75C4.5125 20.25 3.5 19.2375 3.5 18V6.75C3.5 5.5125 4.5125 4.5 5.75 4.5H18.5C19.7375 4.5 20.75 5.5125 20.75 6.75V18Z"></path></svg></button><input id="wl-image-upload" class="upload" type="file" accept=".png,.jpg,.jpeg,.webp,.bmp,.gif"><label for="wl-image-upload" class="wl-action" title="上传图片"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M784 112H240c-88 0-160 72-160 160v480c0 88 72 160 160 160h544c88 0 160-72 160-160V272c0-88-72-160-160-160zm96 640c0 52.8-43.2 96-96 96H240c-52.8 0-96-43.2-96-96V272c0-52.8 43.2-96 96-96h544c52.8 0 96 43.2 96 96v480z" fill="currentColor"></path><path d="M352 480c52.8 0 96-43.2 96-96s-43.2-96-96-96-96 43.2-96 96 43.2 96 96 96zm0-128c17.6 0 32 14.4 32 32s-14.4 32-32 32-32-14.4-32-32 14.4-32 32-32zm462.4 379.2-3.2-3.2-177.6-177.6c-25.6-25.6-65.6-25.6-91.2 0l-80 80-36.8-36.8c-25.6-25.6-65.6-25.6-91.2 0L200 728c-4.8 6.4-8 14.4-8 24 0 17.6 14.4 32 32 32 9.6 0 16-3.2 22.4-9.6L380.8 640l134.4 134.4c6.4 6.4 14.4 9.6 24 9.6 17.6 0 32-14.4 32-32 0-9.6-4.8-17.6-9.6-24l-52.8-52.8 80-80L769.6 776c6.4 4.8 12.8 8 20.8 8 17.6 0 32-14.4 32-32 0-8-3.2-16-8-20.8z" fill="currentColor"></path></svg></label><button class="wl-action" title="预览"><svg viewBox="0 0 1024 1024" width="24" height="24"><path d="M710.816 654.301c70.323-96.639 61.084-230.578-23.705-314.843-46.098-46.098-107.183-71.109-172.28-71.109-65.008 0-126.092 25.444-172.28 71.109-45.227 46.098-70.756 107.183-70.756 172.106 0 64.923 25.444 126.007 71.194 172.106 46.099 46.098 107.184 71.109 172.28 71.109 51.414 0 100.648-16.212 142.824-47.404l126.53 126.006c7.058 7.06 16.297 10.979 26.406 10.979 10.105 0 19.343-3.919 26.402-10.979 14.467-14.467 14.467-38.172 0-52.723L710.816 654.301zm-315.107-23.265c-65.88-65.88-65.88-172.54 0-238.42 32.069-32.07 74.245-49.149 119.471-49.149 45.227 0 87.407 17.603 119.472 49.149 65.88 65.879 65.88 172.539 0 238.42-63.612 63.178-175.242 63.178-238.943 0zm0 0" fill="currentColor"></path><path d="M703.319 121.603H321.03c-109.8 0-199.469 89.146-199.469 199.38v382.034c0 109.796 89.236 199.38 199.469 199.38h207.397c20.653 0 37.384-16.645 37.384-37.299 0-20.649-16.731-37.296-37.384-37.296H321.03c-68.582 0-124.352-55.77-124.352-124.267V321.421c0-68.496 55.77-124.267 124.352-124.267h382.289c68.582 0 124.352 55.771 124.352 124.267V524.72c0 20.654 16.736 37.299 37.385 37.299 20.654 0 37.384-16.645 37.384-37.299V320.549c-.085-109.8-89.321-198.946-199.121-198.946zm0 0" fill="currentColor"></path></svg></button></div><div class="wl-info"><div class="wl-text-number">0 <!--v-if-->  字</div><button class="wl-btn">登录</button><button class="wl-btn primary" title="Cmd|Ctrl + Enter"><!--[-->提交<!--]--></button></div><div class="wl-gif-popup"><input type="text" placeholder="搜索表情包"><div class="wl-gallery" style="gap:6px;"><!--[--><!--]--></div><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div></div><div class="wl-emoji-popup"><!--[--><!--]--><!--v-if--></div></div></div><!--v-if--></div><div class="wl-meta-head"><div class="wl-count"><!--v-if--> 评论</div><ul class="wl-sort"><!--[--><li class="active">按正序</li><li class="">按倒序</li><li class="">按热度</li><!--]--></ul></div><div class="wl-cards"><!--[--><!--]--></div><!--[--><div class="wl-loading"><svg width="30" height="30" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="50" cy="50" fill="none" stroke="currentColor" strokeWidth="4" r="40" stroke-dasharray="85 30"><animateTransform attributeName="transform" type="rotate" repeatCount="indefinite" dur="1s" values="0 50 50;360 50 50" keyTimes="0;1"></animateTransform></circle></svg></div><!--]--><!-- Copyright Information --><div class="wl-power"> Powered by <a href="https://github.com/walinejs/waline" target="_blank" rel="noreferrer"> Waline </a> v2.14.1</div></div></div><!----><!--]--></main><!--]--><footer class="footer-wrapper"><div class="footer">小uの学习笔记</div><div class="copyright">Copyright © 2023 Xiaou</div></footer><!--]--></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.c5b3201b.js" defer></script>
  </body>
</html>
